- if @page.occurrence_map?
  - content_for :head do
    - prefix = @page.id.to_i % 100
    = javascript_include_tag "http://maps.google.com/maps/api/js?key=#{Rails.application.secrets.google_maps_key}"
    = javascript_include_tag "maps_vendored"
    = javascript_include_tag "http://media.eol.org/content/maps/#{prefix}/#{@page.id}.json"
    = javascript_include_tag "maps"
#page
  -# NOTE: it doesn't cache this, so we store it rather than call it over
  -# and over:
  .uk-section.uk-grid-small.uk-padding-small.uk-box-shadow-medium{ style: "background-color: white;", uk: { grid: true } }
    .uk-section.uk-padding-remove-vertical.uk-width-3-5
      #breadcrumbs.page-ancestors.uk-column-span
        %ul.uk-breadcrumb
          - ancestors = @page.native_node.ancestors
          - shown_ellipsis = false
          - ancestors.each do |node|
            - unless node.has_breadcrumb?
              - unless shown_ellipsis
                %li= link_to("â€¦", page_breadcrumbs_path(page_id: @page.id), remote: true)
                - shown_ellipsis = true
              - next
            %li= link_to(node.canonical_form.html_safe, node.page_id ? page_path(node.page_id) : "#")
            - shown_ellipsis = false
      .uk-section{ uk: { grid: true } }
        #names.page-names.uk-width-2-3
          %h1.uk-heading-divider.uk-margin-small-bottom= @page.name.titlecase
          %h3.uk-margin-remove-top= @page.scientific_name.html_safe
          - trophic_strat = begin
            - @page.traits.find { |t| t[:predicate][:uri] == "http://www.wikidata.org/entity/Q1053008" }[:object_term][:name]
          - rescue => e
            -# Do nothing. This code doesn't even belong here. I'm rushing.
          -# TODO: this is all temporary! We need a real solution:
          - trophic_strat = "Plant" if trophic_strat =~ /Plantae/
        .uk-width-1-3
          %a.ui.labeled.small.icon.button.uk-box-shadow-medium{ href: new_collected_page_path(page_id: @page.id) }
            %i.plus.icon
            = t(:taxon_collect_button)
      .uk-section.uk-section-muted.uk-box-shadow-medium.uk-text-lead.uk-text-center.uk-padding-small.uk-margin-small-top.uk-margin-medium-right{style: "font-weight: 300; font-color: #111" }
        = "The #{@page.name} is a #{trophic_strat} #{ancestors[0].name} "
        - if ancestors[-2]
          = "in the #{ancestors[-2].rank.try(:name) || "clade"} #{ancestors[-2].name}."
        It lives in a variety of habitats around the world.
      .uk-section.uk-padding-remove-vertical.uk-margin-top
        %h3.uk-heading-divider= "Key Traits"
        %dl.uk-description-list
          - preds = {}
          - @page.traits.each do |trait|
            - unless preds.keys.size >= 5
              - predicate = @page.glossary[trait[:predicate][:uri]]
              - unless preds.has_key?(predicate)
                - preds[predicate] = true
                %dt.uk-margin-small-top= link_to(predicate[:name], term_path(uri: predicate[:uri]))
                %dd
                  - show_trait_value(trait)
    .uk-width-2-5
      .uk-margin-remove-top
        .uk-overflow-hidden.uk-box-shadow-large
          %img.uk-animation-kenburns.uk-animation-reverse{ src: @page.top_image.original_size_url, style: "border: 2px solid #eee;" }
        -# .uk-cover-container
        -#   %canvas{ width: "1600", height: "1600" }
        -#   %img{ src: @page.top_image.original_size_url, "uk-cover": true }

  .uk-section.uk-padding-remove-vertical.uk-margin-top
    %ul#page_nav.uk-tab.uk-child-width-expand
      - if @page.media_count > 0
        - tab(name: "media", icon: "image", count: @page.media_count, path: page_media_path(page_id: @page.id), active: true)
      - if @page.traits
        - tab(name: "traits", icon: "tag", count: @page.traits.size, path: page_traits_path(page_id: @page.id))
      - if @page.map?
        -# TODO: We want a real count there, eventually.
        - tab(name: "maps", icon: "world", count: 1, path: page_maps_path(page_id: @page.id))
      - if @page.articles.size > 0
        - tab(name: "details", icon: "info", count: @page.articles.size, path: page_details_path(page_id: @page.id))
      - tab(name: "classifications", icon: "network", count: @page.nodes.size, path: page_classifications_path(page_id: @page.id))
      - tab(name: "names", icon: "quote-right", count: @page.names_count, path: page_names_path(page_id: @page.id))
      - if @page.literature_and_references_count > 1
        - tab(name: "literature_and_references", icon: "bookmark", count: @page.literature_and_references_count, path: page_literature_and_references_path(page_id: @page.id))
    #page_nav_content
      = render("page_media")
