- if @page.occurrence_map?
  - content_for :head do
    - prefix = @page.id.to_i % 100
    = javascript_include_tag "http://maps.google.com/maps/api/js?key=#{Rails.application.secrets.google_maps_key}"
    = javascript_include_tag "maps_vendored"
    = javascript_include_tag "http://media.eol.org/content/maps/#{prefix}/#{@page.id}.json"
    = javascript_include_tag "maps"
#page
  -# #page{"data-turbolinks": "false"}
    -# #page_control{ ng: { controller: "PageCtrl as ctrl" } }
  #page_control
    -# NOTE: it doesn't cache this, so we store it rather than call it over
    -# and over:
    - ancestors = @page.native_node.ancestors
    #breadcrumbs.page-ancestors
      %ul.uk-breadcrumb
        - shown_ellipsis = false
        - ancestors.each do |node|
          - unless node.has_breadcrumb?
            - unless shown_ellipsis
              %li= link_to("â€¦", page_breadcrumbs_path(page_id: @page.id), remote: true)
              - shown_ellipsis = true
            - next
          %li= link_to(node.canonical_form.html_safe, node.page_id ? page_path(node.page_id) : "#")
          - shown_ellipsis = false
    .uk-container.uk-grid-small{ uk: { grid: true } }
      .uk-width-2-3
        .uk-container{ uk: { grid: true } }
          #names.page-names.uk-width-2-3
            %h1.uk-heading-divider= @page.name.titlecase
            %h2.uk-margin-remove-top= @page.scientific_name.html_safe
            - trophic_strat = begin
              - @page.traits.find { |t| t[:predicate][:uri] == "http://www.wikidata.org/entity/Q1053008" }[:object_term][:name]
            - rescue => e
              -# Do nothing. This code doesn't even belong here. I'm rushing.
            -# TODO: this is all temporary! We need a real solution:
            - trophic_strat = "Plant" if trophic_strat =~ /Plantae/
            .uk-section.uk-section-muted.uk-text-lead.uk-padding-small
              = "The #{@page.name} is a #{trophic_strat} #{ancestors[0].name} "
              - if ancestors[-2]
                = "in the #{ancestors[-2].rank.try(:name) || "clade"} #{ancestors[-2].name}."
              It lives in a variety of habitats around the world.
            .uk-section.uk-padding-remove-top.uk-margin-top
              %h3.uk-heading-divider= "Key Traits"
              %dl.uk-description-list
                - preds = {}
                - @page.traits.each do |trait|
                  - unless preds.keys.size >= 5
                    - predicate = @page.glossary[trait[:predicate][:uri]]
                    - unless preds.has_key?(predicate)
                      - preds[predicate] = true
                      %dt.uk-margin-small-top= link_to(predicate[:name], term_path(uri: predicate[:uri]))
                      %dd
                        - show_trait_value(trait)
        .uk-width-1-3
          %p
            = link_to t(:taxon_collect_button), new_collected_page_path(page_id: @page.id), class: "uk-button uk-button-primary uk-button-small"
      .uk-width-1-3.uk-margin-remove-top{ uk: { grid: true } }
        .uk-cover-container
          %canvas{ width: "auto", height: "auto" }
          %img{ src: @page.top_image.original_size_url, "uk-cover": true }

    %ul#page_nav.uk-tab.uk-child-width-expand
      - if @page.media_count > 0
        %li#page_nav_media.uk-active{ role: "presentation", title: t("pages.tabs.media"), uk: { tooltip: "delay: 100" } }
          = link_to("<span uk-icon='icon: image; ratio: 2'></span>&ensp;<span class='uk-badge'>#{@page.media_count}</span>".html_safe, page_media_path(page_id: @page.id), remote: true)
      - if @page.traits
        %li#page_nav_traits{ role: "presentation", title: t("pages.tabs.traits"), uk: { tooltip: "delay: 100" } }
          = link_to("<span uk-icon='icon: tag; ratio: 2'></span>&ensp;<span class='uk-badge'>#{@page.traits.size}</span>".html_safe, page_traits_path(page_id: @page.id), remote: true)
      - if @page.map?
        %li#page_nav_maps{ role: "presentation", title: t("pages.tabs.maps"), uk: { tooltip: "delay: 100" } }
          -# TODO: We want a real count there, eventually.
          = link_to("<span uk-icon='icon: world; ratio: 2'></span>&ensp;<span class='uk-badge'>1</span>".html_safe, page_maps_path(page_id: @page.id), remote: true)
      %li#page_nav_classifications{ role: "presentation", title: t("pages.tabs.classifications"), uk: { tooltip: "delay: 100" } }
        = link_to("<span uk-icon='icon: social; ratio: 2'></span>&ensp;<span class='uk-badge'>#{@page.nodes.size}</span>".html_safe, page_classifications_path(page_id: @page.id), remote: true)
      - if @page.articles.size > 1
        %li#page_nav_details{ role: "presentation", title: t("pages.tabs.details"), uk: { tooltip: "delay: 100" } }
          = link_to("<span uk-icon='icon: info; ratio: 2'></span>&ensp;<span class='uk-badge'>#{@page.articles.size}</span>".html_safe, page_details_path(page_id: @page.id), remote: true)
      %li#page_nav_names{ role: "presentation", title: t("pages.tabs.names"), uk: { tooltip: "delay: 100" } }
        = link_to("<span uk-icon='icon: quote-right; ratio: 2'></span>&ensp;<span class='uk-badge'>#{@page.names_count}</span>".html_safe, page_names_path(page_id: @page.id), remote: true)
      - if @page.literature_and_references_count > 1
        %li#page_nav_literature_and_references{ role: "presentation", title: t("pages.tabs.literature_and_references"), uk: { tooltip: "delay: 100" } }
          = link_to("<span uk-icon='icon: bookmark; ratio: 2'></span>&ensp;<span class='uk-badge'>#{@page.literature_and_references_count}</span>".html_safe, page_literature_and_references_path(page_id: @page.id), remote: true)
    #page_nav_content
      = render("page_media")
